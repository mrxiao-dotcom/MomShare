# 数据库设计文档

## 1. 数据库概述

- **数据库类型**：SQLite
- **ORM框架**：Entity Framework Core
- **数据库文件**：MomShares.db

## 2. 数据表设计

### 2.1 产品表（Products）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| Id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| Name | TEXT | NOT NULL | 产品名称 |
| Code | TEXT | NULL | 产品代码（可选） |
| CurrentNetValue | REAL | NOT NULL DEFAULT 1.0 | 当前净值 |
| TotalShares | REAL | NOT NULL DEFAULT 0 | 总份额数量 |
| TotalAmount | REAL | NOT NULL DEFAULT 0 | 总金额 |
| CreatedAt | TEXT | NOT NULL | 创建时间（ISO 8601格式） |
| UpdatedAt | TEXT | NULL | 更新时间 |

**索引**：
- Code（如果Code不为空，应该是唯一的）

### 2.2 持有者表（Holders）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| Id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| Name | TEXT | NOT NULL | 姓名 |
| Phone | TEXT | NOT NULL UNIQUE | 手机号（登录账号） |
| PasswordHash | TEXT | NOT NULL | 密码哈希值 |
| PhoneNumber | TEXT | NULL | 联系电话 |
| Email | TEXT | NULL | 邮箱 |
| BankName | TEXT | NULL | 开户银行 |
| BankAccount | TEXT | NULL | 银行卡号 |
| AccountName | TEXT | NULL | 户名 |
| CreatedAt | TEXT | NOT NULL | 创建时间 |
| UpdatedAt | TEXT | NULL | 更新时间 |

**索引**：
- Phone（唯一索引）

### 2.3 产品净值记录表（ProductNetValues）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| Id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| ProductId | INTEGER | NOT NULL | 产品ID（外键） |
| NetValueDate | TEXT | NOT NULL | 净值日期（ISO 8601格式） |
| NetValue | REAL | NOT NULL | 净值值 |
| CreatedAt | TEXT | NOT NULL | 录入时间 |

**索引**：
- ProductId
- NetValueDate
- (ProductId, NetValueDate) 复合索引

**外键**：
- ProductId -> Products.Id

### 2.4 持有者份额表（HolderShares）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| Id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| HolderId | INTEGER | NOT NULL | 持有者ID（外键） |
| ProductId | INTEGER | NOT NULL | 产品ID（外键） |
| ShareAmount | REAL | NOT NULL DEFAULT 0 | 份额数量 |
| InvestmentAmount | REAL | NOT NULL DEFAULT 0 | 出资金额 |
| CreatedAt | TEXT | NOT NULL | 关联时间 |
| UpdatedAt | TEXT | NULL | 更新时间 |

**索引**：
- HolderId
- ProductId
- (HolderId, ProductId) 唯一复合索引（一个持有者在一个产品中只能有一条记录）

**外键**：
- HolderId -> Holders.Id
- ProductId -> Products.Id

### 2.5 份额操作记录表（ShareTransactions）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| Id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| HolderId | INTEGER | NOT NULL | 持有者ID（外键） |
| ProductId | INTEGER | NOT NULL | 产品ID（外键） |
| TransactionType | TEXT | NOT NULL | 操作类型（InitialInvestment/Transfer/Add/Reduce） |
| TransactionDate | TEXT | NOT NULL | 操作日期 |
| ShareChange | REAL | NOT NULL | 份额变化（正数=增加，负数=减少） |
| TransactionPrice | REAL | NULL | 操作价格 |
| NetValueAtTime | REAL | NOT NULL | 当时净值 |
| CounterpartyId | INTEGER | NULL | 交易对方ID（如果是转让） |
| Remarks | TEXT | NULL | 备注 |
| CreatedAt | TEXT | NOT NULL | 创建时间 |

**索引**：
- HolderId
- ProductId
- TransactionDate
- TransactionType

**外键**：
- HolderId -> Holders.Id
- ProductId -> Products.Id
- CounterpartyId -> Holders.Id

### 2.6 分红记录表（Dividends）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| Id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| ProductId | INTEGER | NOT NULL | 产品ID（外键） |
| DividendDate | TEXT | NOT NULL | 分红日期 |
| TotalAmount | REAL | NOT NULL | 分红总额 |
| CreatedAt | TEXT | NOT NULL | 创建时间 |

**索引**：
- ProductId
- DividendDate

**外键**：
- ProductId -> Products.Id

### 2.7 分红明细表（DividendDetails）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| Id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| DividendId | INTEGER | NOT NULL | 分红ID（外键） |
| HolderId | INTEGER | NOT NULL | 持有者ID（外键） |
| Amount | REAL | NOT NULL | 分红金额 |
| ShareRatio | REAL | NOT NULL | 分红时的份额占比 |
| CreatedAt | TEXT | NOT NULL | 创建时间 |

**索引**：
- DividendId
- HolderId

**外键**：
- DividendId -> Dividends.Id
- HolderId -> Holders.Id

### 2.8 增资记录表（CapitalIncreases）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| Id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| ProductId | INTEGER | NOT NULL | 产品ID（外键） |
| IncreaseDate | TEXT | NOT NULL | 增资日期 |
| AmountBefore | REAL | NOT NULL | 增资前总金额 |
| IncreaseAmount | REAL | NOT NULL | 增资金额 |
| AmountAfter | REAL | NOT NULL | 增资后总金额 |
| CreatedAt | TEXT | NOT NULL | 创建时间 |

**索引**：
- ProductId
- IncreaseDate

**外键**：
- ProductId -> Products.Id

### 2.9 管理员表（Admins）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| Id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| Username | TEXT | NOT NULL UNIQUE | 用户名 |
| PasswordHash | TEXT | NOT NULL | 密码哈希值 |
| CreatedAt | TEXT | NOT NULL | 创建时间 |
| UpdatedAt | TEXT | NULL | 更新时间 |

**索引**：
- Username（唯一索引）

### 2.10 操作日志表（OperationLogs）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| Id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 |
| OperationTime | TEXT | NOT NULL | 操作时间 |
| OperatorType | TEXT | NOT NULL | 操作人类型（Admin/Holder） |
| OperatorId | INTEGER | NOT NULL | 操作人ID |
| OperationType | TEXT | NOT NULL | 操作类型 |
| OperationDetails | TEXT | NULL | 操作详情（JSON格式） |
| IpAddress | TEXT | NULL | IP地址 |
| CreatedAt | TEXT | NOT NULL | 创建时间 |

**索引**：
- OperationTime
- OperatorType
- OperatorId
- OperationType

## 3. 数据关系图

```
Products (1) ----< (N) ProductNetValues
Products (1) ----< (N) HolderShares
Products (1) ----< (N) ShareTransactions
Products (1) ----< (N) Dividends
Products (1) ----< (N) CapitalIncreases

Holders (1) ----< (N) HolderShares
Holders (1) ----< (N) ShareTransactions
Holders (1) ----< (N) DividendDetails
Holders (1) ----< (N) ShareTransactions (作为CounterpartyId)

Dividends (1) ----< (N) DividendDetails
```

## 4. 数据约束和业务规则

### 4.1 数据完整性约束
1. **外键约束**：所有外键必须引用有效的主键
2. **唯一性约束**：
   - Holders.Phone 唯一
   - Admins.Username 唯一
   - (HolderId, ProductId) 在HolderShares中唯一
3. **非空约束**：关键字段不允许为空

### 4.2 业务规则验证
1. **份额占比验证**：单个产品的所有持有者份额占比总和必须等于100%
2. **净值调整限制**：只有净值为1.0时才能进行份额调整
3. **份额权益计算**：份额权益 = 当前净值 × 份额数量

## 5. 数据库初始化

### 5.1 初始数据
- 创建默认管理员账号（用户名：admin，密码：admin123，首次登录需修改）

### 5.2 数据库迁移
- 使用Entity Framework Core Migrations管理数据库结构变更

## 6. 备份和恢复

### 6.1 备份策略
- 备份整个SQLite数据库文件（.db）
- 备份文件命名：MomShares_backup_YYYYMMDD_HHMMSS.db
- 支持压缩备份（.zip格式）

### 6.2 恢复策略
- 从备份文件恢复数据库
- 恢复前备份当前数据库
- 恢复后验证数据完整性

