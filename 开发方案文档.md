# 开发方案文档

## 1. 项目结构

```
MomShares/
├── MomShares.Server/              # WPF控制端项目
│   ├── Views/                     # WPF视图
│   ├── ViewModels/                # MVVM视图模型
│   ├── Services/                  # 服务类
│   └── Models/                    # 数据模型
│
├── MomShares.Api/                 # ASP.NET Core Web API项目
│   ├── Controllers/               # API控制器
│   ├── Services/                  # 业务逻辑服务
│   ├── Models/                    # DTO模型
│   ├── Data/                      # 数据访问层
│   ├── Middleware/                # 中间件
│   └── Filters/                   # 过滤器
│
├── MomShares.Core/                # 核心类库（共享）
│   ├── Entities/                  # 实体类
│   ├── Interfaces/                # 接口定义
│   ├── Enums/                     # 枚举类型
│   └── Helpers/                   # 辅助类
│
├── MomShares.Infrastructure/      # 基础设施类库
│   ├── Data/                      # EF Core配置
│   ├── Repositories/              # 仓储模式实现
│   └── Services/                  # 基础设施服务（备份、日志等）
│
├── MomShares.Web/                 # Web前端项目（可选，如果使用前后端分离）
│   └── (React/Vue/Angular项目)
│
└── docs/                          # 文档目录
    ├── 需求文档.md
    ├── 数据库设计文档.md
    └── 开发方案文档.md
```

## 2. 技术栈详细说明

### 2.1 WPF控制端（MomShares.Server）
- **框架**：.NET 8 WPF
- **MVVM框架**：CommunityToolkit.Mvvm 或 Prism
- **依赖注入**：Microsoft.Extensions.DependencyInjection
- **配置管理**：Microsoft.Extensions.Configuration
- **日志**：Serilog 或 NLog

### 2.2 Web API（MomShares.Api）
- **框架**：ASP.NET Core 8.0
- **ORM**：Entity Framework Core 8.0
- **数据库**：SQLite（Microsoft.EntityFrameworkCore.Sqlite）
- **认证**：JWT Bearer Token（Microsoft.AspNetCore.Authentication.JwtBearer）
- **密码加密**：BCrypt.Net-Next
- **API文档**：Swagger/OpenAPI
- **CORS**：支持跨域请求
- **日志**：Serilog

### 2.3 核心类库（MomShares.Core）
- **框架**：.NET Standard 2.1 或 .NET 8
- **包含**：实体类、接口、枚举、常量、辅助类

### 2.4 基础设施类库（MomShares.Infrastructure）
- **框架**：.NET 8
- **包含**：EF Core配置、仓储实现、备份服务、日志服务

### 2.5 Web前端（可选）
- **方案1**：React + TypeScript + Ant Design / Material-UI
- **方案2**：Vue 3 + TypeScript + Element Plus / Vuetify
- **方案3**：Angular + TypeScript + Angular Material
- **HTTP客户端**：Axios 或 Fetch API
- **状态管理**：Redux/Zustand（React）或 Pinia（Vue）

## 3. 开发阶段规划

### 阶段1：项目搭建和基础架构（1-2天）

#### 1.1 创建项目结构
- [ ] 创建解决方案文件
- [ ] 创建各个项目（Server、Api、Core、Infrastructure）
- [ ] 配置项目引用关系
- [ ] 配置NuGet包

#### 1.2 数据库设计实现
- [ ] 创建实体类（Entity Framework Core）
- [ ] 配置DbContext
- [ ] 创建数据库迁移
- [ ] 初始化数据库

#### 1.3 基础服务搭建
- [ ] 配置依赖注入容器
- [ ] 配置日志系统
- [ ] 配置配置文件（appsettings.json）
- [ ] 创建基础仓储接口和实现

### 阶段2：后端API开发（5-7天）

#### 2.1 认证授权模块
- [ ] JWT Token生成和验证
- [ ] 登录接口（管理员、持有者）
- [ ] 密码加密和验证
- [ ] 权限中间件

#### 2.2 产品管理API
- [ ] 创建产品
- [ ] 获取产品列表
- [ ] 获取产品详情
- [ ] 更新产品信息
- [ ] 删除产品（可选）

#### 2.3 净值管理API
- [ ] 录入净值
- [ ] 批量导入净值
- [ ] 获取净值历史记录
- [ ] 获取净值走势数据（用于图表）

#### 2.4 持有者管理API
- [ ] 创建持有者
- [ ] 获取持有者列表
- [ ] 获取持有者详情
- [ ] 更新持有者信息
- [ ] 修改持有者密码

#### 2.5 份额管理API
- [ ] 关联产品和持有者
- [ ] 确定份额（初始出资）
- [ ] 份额转让
- [ ] 新增份额
- [ ] 减持份额
- [ ] 获取持有者份额列表
- [ ] 验证份额占比约束

#### 2.6 分红管理API
- [ ] 创建分红记录
- [ ] 计算分红分配
- [ ] 获取分红记录列表
- [ ] 获取持有者分红记录

#### 2.7 增资管理API
- [ ] 创建增资记录
- [ ] 重新计算份额占比
- [ ] 获取增资历史记录

#### 2.8 系统管理API
- [ ] 数据备份（手动）
- [ ] 数据恢复
- [ ] 管理员管理（创建、列表、修改密码）
- [ ] 操作日志查询

### 阶段3：WPF控制端开发（2-3天）

#### 3.1 主窗口设计
- [ ] 服务启动/停止按钮
- [ ] 服务状态显示
- [ ] 配置管理界面
- [ ] 日志显示窗口

#### 3.2 服务管理
- [ ] 启动Web API服务
- [ ] 停止Web API服务
- [ ] 服务状态监控
- [ ] 端口配置

#### 3.3 配置管理
- [ ] 备份路径配置
- [ ] 自动备份时间配置
- [ ] 服务端口配置
- [ ] 数据库路径配置

#### 3.4 日志显示
- [ ] 实时日志显示
- [ ] 日志级别过滤
- [ ] 日志保存

### 阶段4：Web前端开发（5-7天）

#### 4.1 前端项目搭建
- [ ] 创建前端项目
- [ ] 配置路由
- [ ] 配置HTTP客户端
- [ ] 配置状态管理
- [ ] 配置UI组件库

#### 4.2 管理员界面
- [ ] 登录页面
- [ ] 产品管理页面
- [ ] 净值管理页面
- [ ] 持有者管理页面
- [ ] 份额管理页面
- [ ] 分红管理页面
- [ ] 增资管理页面
- [ ] 系统设置页面
- [ ] 操作日志页面

#### 4.3 持有者界面
- [ ] 登录页面
- [ ] 我的份额页面
- [ ] 净值走势页面（图表）
- [ ] 分红记录页面

#### 4.4 通用组件
- [ ] 布局组件
- [ ] 表格组件
- [ ] 表单组件
- [ ] 图表组件（净值走势）
- [ ] 文件上传组件（批量导入）

### 阶段5：系统集成和测试（2-3天）

#### 5.1 功能测试
- [ ] 单元测试
- [ ] 集成测试
- [ ] API接口测试
- [ ] 前端功能测试

#### 5.2 业务规则验证
- [ ] 份额占比约束验证
- [ ] 净值调整限制验证
- [ ] 分红计算验证
- [ ] 增资后占比重新计算验证

#### 5.3 性能优化
- [ ] 数据库查询优化
- [ ] API响应时间优化
- [ ] 前端性能优化

#### 5.4 错误处理
- [ ] 异常处理
- [ ] 错误提示
- [ ] 日志记录

## 4. 关键功能实现细节

### 4.1 份额占比验证

```csharp
// 伪代码
public bool ValidateShareRatio(int productId)
{
    var totalShares = GetTotalShares(productId);
    var holderShares = GetHolderShares(productId);
    var sumRatio = holderShares.Sum(h => h.ShareAmount / totalShares);
    return Math.Abs(sumRatio - 1.0) < 0.0001; // 允许浮点数误差
}
```

### 4.2 净值调整限制

```csharp
// 伪代码
public bool CanAdjustShares(int productId)
{
    var product = GetProduct(productId);
    return Math.Abs(product.CurrentNetValue - 1.0) < 0.0001;
}
```

### 4.3 分红分配计算

```csharp
// 伪代码
public List<DividendDetail> CalculateDividend(int productId, decimal totalAmount)
{
    var holderShares = GetHolderShares(productId);
    var totalShares = GetTotalShares(productId);
    var details = new List<DividendDetail>();
    
    foreach (var holderShare in holderShares)
    {
        var ratio = holderShare.ShareAmount / totalShares;
        var amount = totalAmount * ratio;
        details.Add(new DividendDetail
        {
            HolderId = holderShare.HolderId,
            Amount = amount,
            ShareRatio = ratio
        });
    }
    
    return details;
}
```

### 4.4 增资后占比重新计算

```csharp
// 伪代码
public void RecalculateShareRatioAfterCapitalIncrease(int productId, decimal newTotalAmount)
{
    var holderShares = GetHolderShares(productId);
    
    foreach (var holderShare in holderShares)
    {
        // 份额数量不变，但占比会变化
        // 新的占比 = 持有者份额金额 / 新的总金额
        var newRatio = holderShare.InvestmentAmount / newTotalAmount;
        // 更新产品总金额
        UpdateProductTotalAmount(productId, newTotalAmount);
    }
}
```

### 4.5 数据备份服务

```csharp
// 伪代码
public class BackupService
{
    public void BackupDatabase(string backupPath)
    {
        var dbPath = GetDatabasePath();
        var backupFileName = $"MomShares_backup_{DateTime.Now:yyyyMMdd_HHmmss}.db";
        var backupFilePath = Path.Combine(backupPath, backupFileName);
        
        File.Copy(dbPath, backupFilePath);
        
        // 可选：压缩备份文件
        CompressBackup(backupFilePath);
    }
    
    public void RestoreDatabase(string backupFilePath)
    {
        // 恢复前备份当前数据库
        BackupDatabase(GetBackupPath());
        
        // 恢复数据库
        var dbPath = GetDatabasePath();
        File.Copy(backupFilePath, dbPath, true);
    }
}
```

## 5. API接口设计

### 5.1 认证接口
- `POST /api/auth/admin/login` - 管理员登录
- `POST /api/auth/holder/login` - 持有者登录
- `POST /api/auth/refresh` - 刷新Token

### 5.2 产品管理接口
- `GET /api/products` - 获取产品列表
- `GET /api/products/{id}` - 获取产品详情
- `POST /api/products` - 创建产品
- `PUT /api/products/{id}` - 更新产品
- `DELETE /api/products/{id}` - 删除产品

### 5.3 净值管理接口
- `POST /api/products/{id}/netvalues` - 录入净值
- `POST /api/products/{id}/netvalues/batch` - 批量导入净值
- `GET /api/products/{id}/netvalues` - 获取净值历史
- `GET /api/products/{id}/netvalues/chart` - 获取净值走势数据

### 5.4 持有者管理接口
- `GET /api/holders` - 获取持有者列表
- `GET /api/holders/{id}` - 获取持有者详情
- `POST /api/holders` - 创建持有者
- `PUT /api/holders/{id}` - 更新持有者信息
- `PUT /api/holders/{id}/password` - 修改密码

### 5.5 份额管理接口
- `POST /api/shares` - 关联产品和持有者（确定份额）
- `POST /api/shares/transfer` - 份额转让
- `POST /api/shares/add` - 新增份额
- `POST /api/shares/reduce` - 减持份额
- `GET /api/shares/holder/{holderId}` - 获取持有者份额列表
- `GET /api/shares/product/{productId}` - 获取产品份额列表

### 5.6 分红管理接口
- `POST /api/dividends` - 创建分红
- `GET /api/dividends/product/{productId}` - 获取产品分红记录
- `GET /api/dividends/holder/{holderId}` - 获取持有者分红记录

### 5.7 增资管理接口
- `POST /api/capital-increases` - 创建增资记录
- `GET /api/capital-increases/product/{productId}` - 获取增资历史

### 5.8 系统管理接口
- `POST /api/system/backup` - 手动备份
- `POST /api/system/restore` - 恢复数据
- `GET /api/system/backups` - 获取备份列表
- `GET /api/admins` - 获取管理员列表
- `POST /api/admins` - 创建管理员
- `PUT /api/admins/{id}/password` - 修改管理员密码
- `GET /api/logs` - 获取操作日志

## 6. 配置文件结构

### 6.1 appsettings.json（API项目）

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Data Source=MomShares.db"
  },
  "JwtSettings": {
    "SecretKey": "your-secret-key-here",
    "Issuer": "MomShares",
    "Audience": "MomShares",
    "ExpirationMinutes": 1440
  },
  "BackupSettings": {
    "BackupPath": "D:\\Backups\\MomShares",
    "AutoBackupEnabled": true,
    "AutoBackupTime": "02:00:00"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information"
    }
  }
}
```

### 6.2 appsettings.json（WPF项目）

```json
{
  "ApiSettings": {
    "BaseUrl": "http://localhost:5000",
    "Port": 5000
  },
  "DatabaseSettings": {
    "DatabasePath": "MomShares.db"
  },
  "BackupSettings": {
    "BackupPath": "D:\\Backups\\MomShares",
    "AutoBackupEnabled": true,
    "AutoBackupTime": "02:00:00"
  }
}
```

## 7. 开发注意事项

### 7.1 数据一致性
- 使用事务确保数据一致性
- 份额操作后必须验证占比约束
- 净值更新后自动更新份额权益

### 7.2 错误处理
- 统一的异常处理机制
- 友好的错误提示信息
- 详细的错误日志记录

### 7.3 安全性
- 密码加密存储（BCrypt）
- JWT Token安全配置
- API接口权限验证
- SQL注入防护（使用参数化查询）

### 7.4 性能优化
- 数据库索引优化
- 查询结果分页
- 缓存常用数据
- 异步操作

## 8. 测试策略

### 8.1 单元测试
- 业务逻辑测试
- 服务类测试
- 工具类测试

### 8.2 集成测试
- API接口测试
- 数据库操作测试
- 认证授权测试

### 8.3 端到端测试
- 完整业务流程测试
- 用户场景测试

## 9. 部署方案

### 9.1 开发环境
- 本地SQLite数据库
- 本地Web API服务
- 本地前端开发服务器

### 9.2 生产环境
- SQLite数据库文件（可配置路径）
- Web API服务（可配置端口）
- 前端静态文件（可部署到IIS/Nginx）

## 10. 后续扩展功能（可选）

1. 数据导出（Excel/PDF）
2. 净值自动采集（定时任务）
3. 邮件通知（分红、净值变化）
4. 移动端适配
5. 多语言支持
6. 数据统计分析报表

