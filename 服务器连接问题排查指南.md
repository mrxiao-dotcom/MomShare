# 服务器连接问题排查指南

## 错误信息
```
82.157.28.78 拒绝了我们的连接请求
ERR_CONNECTION_REFUSED
```

## 可能的原因和解决方案

### 1. 检查服务是否正在运行

**在服务器上检查：**
- 打开 WPF 程序（MomShares.Server）
- 确认服务状态显示为"运行中"
- 查看日志，确认显示"Web服务器已启动"

**如果服务未运行：**
- 点击"启动服务"按钮
- 等待服务启动完成
- 查看日志确认启动成功

---

### 2. 检查防火墙配置

**Windows 防火墙：**

#### 方法一：PowerShell（推荐）
以管理员身份运行 PowerShell，执行：
```powershell
# 检查端口 5000 的防火墙规则
Get-NetFirewallRule -DisplayName "*5000*" | Format-Table DisplayName, Enabled, Direction, Action -AutoSize

# 如果没有规则，创建规则
New-NetFirewallRule -DisplayName "MomShares Web Server (Port 5000)" -Direction Inbound -LocalPort 5000 -Protocol TCP -Action Allow -Profile Domain,Private,Public
```

#### 方法二：图形界面
1. 按 `Win + R`，输入 `wf.msc`，回车
2. 左侧选择"入站规则" → 右侧点击"新建规则..."
3. 选择"端口" → 下一步
4. 选择"TCP"，输入端口 `5000` → 下一步
5. 选择"允许连接" → 下一步
6. 勾选所有配置文件（域、专用、公用）→ 下一步
7. 名称输入：`MomShares Web Server (Port 5000)` → 完成

**云服务器防火墙（如果适用）：**
- 登录云服务器控制台
- 找到"安全组"或"防火墙"设置
- 添加入站规则：端口 5000，协议 TCP，允许所有来源（0.0.0.0/0）

---

### 3. 检查服务监听地址

**确认服务监听所有网络接口：**

1. 在服务器上，打开 WPF 程序
2. 查看日志，确认显示：
   ```
   网络访问: http://<服务器IP>:5000
   ```
   或显示实际的 IP 地址

3. 如果只显示 `localhost`，说明配置有问题

**验证监听地址：**
在服务器上，打开 PowerShell，执行：
```powershell
# 检查端口 5000 是否被监听
netstat -ano | findstr :5000
```

应该看到类似：
```
TCP    0.0.0.0:5000           0.0.0.0:0              LISTENING       <进程ID>
```

如果看到 `127.0.0.1:5000` 而不是 `0.0.0.0:5000`，说明服务只监听本地，需要修改配置。

---

### 4. 检查端口是否被占用

**在服务器上执行：**
```powershell
# 检查端口 5000 是否被占用
netstat -ano | findstr :5000
```

如果端口被其他程序占用：
- 停止占用端口的程序
- 或者修改 WPF 程序中的端口号（在配置中修改 ApiPort）

---

### 5. 检查网络连接

**从服务器测试：**
```powershell
# 测试本地连接
Test-NetConnection -ComputerName localhost -Port 5000
```

**从外部测试（在另一台机器上）：**
```powershell
# 测试外部连接（替换为实际服务器IP）
Test-NetConnection -ComputerName 82.157.28.78 -Port 5000
```

---

### 6. 检查云服务器安全组（如果适用）

如果服务器在云平台（阿里云、腾讯云、AWS等）：

1. **登录云服务器控制台**
2. **找到安全组配置**
3. **添加入站规则：**
   - 端口范围：`5000`
   - 协议：`TCP`
   - 授权对象：`0.0.0.0/0`（允许所有IP）或指定IP范围
   - 描述：`MomShares Web Server`

---

### 7. 检查服务日志

**查看 WPF 程序日志：**
- 确认服务已启动
- 查看是否有错误信息
- 确认显示的监听地址

**常见日志信息：**
```
[WebAppBuilder] 当前工作目录: ...
[WebAppBuilder] Web根目录: ...
[WebAppBuilder] wwwroot存在: True
[WebAppBuilder] 数据库连接字符串: ...
```

---

### 8. 测试步骤

**步骤 1：在服务器本地测试**
1. 在服务器上打开浏览器
2. 访问：`http://localhost:5000`
3. 如果无法访问，说明服务未启动或配置有问题

**步骤 2：在服务器上使用 IP 测试**
1. 在服务器上打开浏览器
2. 访问：`http://<服务器内网IP>:5000`
3. 如果无法访问，检查防火墙配置

**步骤 3：从外部测试**
1. 从其他机器访问：`http://82.157.28.78:5000`
2. 如果无法访问，检查：
   - 云服务器安全组
   - 服务器防火墙
   - 服务是否监听 0.0.0.0

---

### 9. 快速诊断命令

**在服务器上执行以下命令进行诊断：**

```powershell
# 1. 检查服务是否监听端口 5000
netstat -ano | findstr :5000

# 2. 检查防火墙规则
Get-NetFirewallRule -DisplayName "*5000*" | Format-Table DisplayName, Enabled, Direction, Action

# 3. 测试本地连接
Test-NetConnection -ComputerName localhost -Port 5000

# 4. 查看所有监听端口
netstat -ano | findstr LISTENING
```

---

### 10. 常见问题解决

**问题 1：服务启动但无法访问**
- 检查防火墙是否开放端口 5000
- 检查服务是否监听 0.0.0.0 而不是 localhost

**问题 2：本地可以访问，外部无法访问**
- 检查云服务器安全组配置
- 检查 Windows 防火墙规则
- 确认服务监听 0.0.0.0

**问题 3：端口被占用**
- 修改 WPF 程序中的端口号
- 或停止占用端口的程序

**问题 4：服务启动失败**
- 查看 WPF 程序日志
- 检查数据库路径是否正确
- 检查 wwwroot 目录是否存在

---

### 11. 验证配置

**确认以下配置正确：**

1. **WPF 程序配置：**
   - ApiPort: `5000`（或您设置的端口）
   - 服务状态：`运行中`

2. **服务监听地址：**
   - 应该是 `http://0.0.0.0:5000`
   - 不是 `http://localhost:5000`

3. **防火墙规则：**
   - 入站规则：允许 TCP 5000 端口
   - 应用于：域、专用、公用

4. **云服务器安全组（如果适用）：**
   - 入站规则：允许 TCP 5000 端口
   - 来源：0.0.0.0/0

---

## 联系支持

如果以上步骤都无法解决问题，请提供：
1. WPF 程序的完整日志
2. `netstat -ano | findstr :5000` 的输出
3. `Get-NetFirewallRule -DisplayName "*5000*"` 的输出
4. 服务器操作系统版本
5. 是否在云服务器上运行

