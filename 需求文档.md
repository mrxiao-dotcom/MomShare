# MomShares 产品份额管理系统 - 需求文档

## 1. 项目概述

MomShares 是一个产品份额管理系统，用于管理产品、持有者及其份额关系。系统采用WPF桌面程序作为服务器控制端，提供Web API服务，支持管理员和持有者两种角色的Web访问。

## 2. 技术架构

### 2.1 技术栈
- **服务器控制端**：WPF桌面应用程序（.NET 6/7/8）
- **后端服务**：ASP.NET Core Web API
- **前端**：Web前端（前后端分离，建议使用React/Vue/Angular）
- **数据库**：SQLite
- **认证**：JWT Token认证

### 2.2 系统架构
```
WPF控制端（启动/停止服务）
    ↓
ASP.NET Core Web API（后端服务）
    ↓
SQLite数据库
```

## 3. 功能需求

### 3.1 产品管理

#### 3.1.1 创建产品
- 产品基本信息：产品名称、产品代码（可选）、创建时间
- 创建时不需要初始持有者
- 产品初始净值为1.0

#### 3.1.2 录入净值
- 支持手动录入净值
- 支持历史净值批量导入（Excel/CSV格式）
- 记录净值日期和净值值
- 净值变化时，持有者份额数量不变，份额权益自动更新
- 份额权益 = 净值 × 份额数量

#### 3.1.3 分红
- 输入分红总额
- 按照持有者份额比例自动分配分红
- 分红不影响份额数量和占比
- 记录分红日期、分红总额、每个持有者的分红金额

#### 3.1.4 增资
- 产品整体增资（例如：100万增资到150万）
- 增资后必须重新分配份额比例
- 新增持有者可以参与增资
- 原有持有者份额数量不变，但持股比例会发生变化
- 记录增资日期、增资金额、增资后总金额

**增资示例**：
- 原产品：100万，持有者A占60%（60万），持有者B占40%（40万）
- 增资到150万，新增50万
- 新增持有者C：20万，持有者D：30万
- 结果：
  - 持有者A：60万，占比40%（60/150）
  - 持有者B：40万，占比26.67%（40/150）
  - 持有者C：20万，占比13.33%（20/150）
  - 持有者D：30万，占比20%（30/150）

### 3.2 持有者管理

#### 3.2.1 创建持有者
- 基本信息：姓名、手机号（作为登录账号）、密码（默认888888）
- 联系方式：电话、邮箱（可选）
- 银行卡信息：开户银行、银行卡号、户名
- 创建时间

#### 3.2.2 编辑持有者信息
- 可编辑：姓名、联系方式、银行卡信息
- 可修改密码
- 手机号不可修改（作为唯一标识）

### 3.3 份额管理

#### 3.3.1 关联产品
- 为持有者关联产品
- 一个持有者可以参与多个产品
- 一个产品可以有多个持有者

#### 3.3.2 确定份额（出资记录）
- 记录持有者对产品的初始出资
- 份额单位：绝对数量（初始1元=1份）
- 记录出资日期、出资金额、对应份额数量

#### 3.3.3 份额转让
- 支持持有者之间转让
- 支持新增持有者从原持有者处受让
- 必须记录：转让日期、转让份额数量、转让价格、当时净值
- **限制**：只有当产品净值为1时，才允许进行份额调整（包括转让、新增、减持）

#### 3.3.4 新增份额
- 持有者可以新增对产品的份额
- 必须记录：新增日期、新增份额数量、出资金额、当时净值
- **限制**：仅当净值为1时允许

#### 3.3.5 减持份额
- 持有者可以减少对产品的份额
- 必须记录：减持日期、减持份额数量、回收金额、当时净值
- **限制**：仅当净值为1时允许

#### 3.3.6 份额占比约束
- 单个产品的所有持有者份额占比总和必须等于100%
- 份额占比 = 持有者份额数量 / 产品总份额数量

### 3.4 用户访问功能

#### 3.4.1 管理员功能（Web界面）
- 产品管理：创建、录入净值、分红、增资
- 持有者管理：创建、编辑持有者信息
- 份额管理：关联产品、确定份额、转让、新增、减持
- 数据备份：手动备份、自动备份设置
- 数据恢复：从备份文件恢复
- 管理员管理：创建管理员、设置密码
- 查看操作日志

#### 3.4.2 持有者功能（Web界面）
- 登录：使用手机号+密码登录
- 查看自己的份额：查看所有参与的产品及份额信息
- 查看产品历史净值走势：图表展示净值变化趋势
- 查看分红记录：查看所有产品的分红记录及金额

### 3.5 系统管理功能

#### 3.5.1 数据备份
- **手动备份**：管理员可随时触发备份
- **自动备份**：每天自动备份（可配置备份时间）
- **备份存储**：本地文件系统，路径可配置
- **备份文件格式**：SQLite数据库文件（.db）或压缩包（.zip）

#### 3.5.2 数据恢复
- 从备份文件恢复数据
- 恢复前需要确认（防止误操作）
- 恢复后需要重新登录

#### 3.5.3 管理员管理
- 创建管理员账号
- 设置/修改管理员密码
- 管理员列表查看

#### 3.5.4 操作日志
- 记录所有关键操作：产品创建、净值录入、分红、增资、持有者创建/编辑、份额操作等
- 日志信息：操作时间、操作人、操作类型、操作详情
- 支持日志查询和筛选
- 仅支持中文

## 4. 数据模型

### 4.1 核心实体

#### 产品（Product）
- Id（主键）
- 产品名称
- 产品代码（可选）
- 创建时间
- 当前净值
- 总份额数量
- 总金额

#### 持有者（Holder）
- Id（主键）
- 姓名
- 手机号（唯一，登录账号）
- 密码（加密存储）
- 电话
- 邮箱
- 开户银行
- 银行卡号
- 户名
- 创建时间

#### 产品净值记录（ProductNetValue）
- Id（主键）
- 产品Id（外键）
- 净值日期
- 净值值
- 录入时间

#### 持有者份额（HolderShare）
- Id（主键）
- 持有者Id（外键）
- 产品Id（外键）
- 份额数量
- 出资金额
- 关联时间

#### 份额操作记录（ShareTransaction）
- Id（主键）
- 持有者Id（外键）
- 产品Id（外键）
- 操作类型（出资、转让、新增、减持）
- 操作日期
- 份额数量变化（正数表示增加，负数表示减少）
- 操作价格
- 当时净值
- 交易对方（如果是转让）
- 备注

#### 分红记录（Dividend）
- Id（主键）
- 产品Id（外键）
- 分红日期
- 分红总额
- 创建时间

#### 分红明细（DividendDetail）
- Id（主键）
- 分红Id（外键）
- 持有者Id（外键）
- 分红金额
- 份额占比（分红时的占比）

#### 增资记录（CapitalIncrease）
- Id（主键）
- 产品Id（外键）
- 增资日期
- 增资前总金额
- 增资金额
- 增资后总金额
- 创建时间

#### 管理员（Admin）
- Id（主键）
- 用户名（唯一）
- 密码（加密存储）
- 创建时间

#### 操作日志（OperationLog）
- Id（主键）
- 操作时间
- 操作人类型（管理员/持有者）
- 操作人Id
- 操作类型
- 操作详情（JSON格式存储详细信息）
- IP地址

## 5. 业务规则

### 5.1 份额调整限制
- **规则**：只有当产品当前净值为1.0时，才允许进行份额调整操作
- **适用操作**：份额转让、新增份额、减持份额
- **验证**：操作前必须检查产品当前净值是否为1.0

### 5.2 份额占比约束
- **规则**：单个产品的所有持有者份额占比总和必须等于100%
- **验证**：每次份额操作后，必须验证占比总和是否为100%
- **计算**：占比 = 持有者份额数量 / 产品总份额数量

### 5.3 份额权益计算
- **公式**：份额权益 = 当前净值 × 持有者份额数量
- **更新时机**：净值变化时自动更新（份额数量不变）

### 5.4 分红分配
- **规则**：按照持有者份额占比分配分红
- **公式**：持有者分红金额 = 分红总额 × 持有者份额占比
- **影响**：分红不影响份额数量和占比

### 5.5 增资后份额重新分配
- **规则**：增资后，原有持有者份额数量不变，但占比会发生变化
- **计算**：新占比 = 持有者份额金额 / 增资后总金额
- **验证**：增资后所有持有者占比总和必须等于100%

## 6. 用户界面要求

### 6.1 WPF控制端界面
- 启动/停止Web服务按钮
- 服务状态显示（运行中/已停止）
- 服务端口配置
- 备份路径配置
- 自动备份时间配置
- 日志显示窗口

### 6.2 Web管理员界面
- 登录页面
- 产品管理页面（列表、创建、编辑）
- 净值管理页面（录入、批量导入、历史记录）
- 持有者管理页面（列表、创建、编辑）
- 份额管理页面（关联产品、份额操作）
- 分红管理页面
- 增资管理页面
- 系统设置页面（备份、恢复、管理员管理）
- 操作日志页面

### 6.3 Web持有者界面
- 登录页面（手机号+密码）
- 我的份额页面（产品列表、份额详情）
- 净值走势页面（图表展示）
- 分红记录页面

## 7. 非功能需求

### 7.1 性能要求
- 支持至少100个产品
- 支持至少1000个持有者
- 净值历史记录支持至少1000条
- 页面响应时间 < 2秒

### 7.2 安全要求
- 密码加密存储（BCrypt或类似算法）
- JWT Token认证，Token有效期可配置
- API接口权限验证
- SQL注入防护
- XSS防护

### 7.3 数据完整性
- 外键约束
- 事务处理
- 数据验证

### 7.4 可维护性
- 代码注释
- 日志记录
- 错误处理

## 8. 开发计划

### 阶段1：项目搭建和数据库设计
- 创建项目结构
- 设计数据库表结构
- 创建Entity Framework Core模型

### 阶段2：后端API开发
- 认证授权模块
- 产品管理API
- 持有者管理API
- 份额管理API
- 净值管理API
- 分红管理API
- 增资管理API
- 系统管理API

### 阶段3：WPF控制端开发
- 服务启动/停止功能
- 配置管理
- 日志显示

### 阶段4：Web前端开发
- 管理员界面
- 持有者界面

### 阶段5：测试和优化
- 单元测试
- 集成测试
- 性能优化

## 9. 待确认问题

1. 前端框架选择：React、Vue还是Angular？
2. 是否需要支持多管理员同时操作？
3. 份额转让是否需要双方确认？
4. 净值历史数据是否需要支持删除和修改？
5. 备份文件是否需要加密？
6. 是否需要支持数据导出（Excel/PDF）？

